don_carlos_exile_country_selector = {
	hidden_effect = {
		#c:FRA = {
		#	trigger_event = { id = cr_carlist_events.15 days = 4 }
		#}
		#c:GBR = {
		#	trigger_event = { id = cr_carlist_events.16 days = 4 }
		#}
		c:POR = {
			trigger_event = { id = cr_carlist_events.80 days = 4 }
		}
		#c:USA = {
		#	trigger_event = { id = cr_carlist_events.90 days = 4 }
		#}
	}
}

don_carlos_granted_asylum_effect = {
	save_scope_as = don_carlos_exile_country
	if = {
		limit = {
			c:USA ?= this
		}
		c:SPA = {
			set_variable = don_carlos_usa_exile_var
			trigger_event = { id =  cr_carlist_events.91 days = 5 }
		}
		show_as_tooltip = {
			scope:carlist_movement = {
				add_modifier = {
					name = cr_distant_exile	
				}
			}
		}
		show_as_tooltip = {
			c:SPA = {
				change_relations = {
					country = ROOT
					value = 5
				}
			}
		}
	}
	else_if = {
		limit = {
			c:POR ?= this
		}
		custom_tooltip = {
			text = cr_carlist_events.16.b_tt
		}
		c:SPA = {
			set_variable = don_carlos_portugal_exile_var
			trigger_event = { id =  cr_carlist_events.20 days = 5 }
		}
		show_as_tooltip = {
			scope:carlist_movement = {
				add_modifier = {
					name = cr_don_carlos_exiled_but_supported	
				}
			}
		}
		scope:don_carlos_exile_state = {
			add_modifier = {
				name = cr_carlos_exiled_state	
				months = 360
			}
		}
		if = {
			limit = {
				c:SIC = {
					has_law = law_type:law_monarchy
				}
			}
			c:SIC = {
				change_relations = {
					country = ROOT
					value = -5
				}
			}
		}
		
	}
	else = {
		if = {
			limit = {
				any_scope_state = {
					state_region = s:STATE_ORLEANS
				}
			}
			custom_tooltip = {
				text = cr_carlist_events.15.a_tt
			}
		}
		else = {
			custom_tooltip = {
				text = cr_carlist_events.16.b_tt
			}
		}
		scope:don_carlos_exile_state = {
			add_modifier = {
				name = cr_carlos_exiled_state	
				months = 360
			}
		}
		c:SPA = {
			trigger_event = { id =  cr_carlist_events.20 days = 5 }
		}
		show_as_tooltip = {
			scope:carlist_movement = {
				add_modifier = {
					name = cr_exile_of_bourges	
				}
			}
		}
		if = {
			limit = {
				c:SIC = {
					has_law = law_type:law_monarchy
				}
			}
			c:SIC = {
				change_relations = {
					country = ROOT
					value = -5
				}
			}
		}
	}
	if = {
		limit = {
			ruler = {
				has_ideology = ideology:ideology_bonapartist
			}
			NOT = {
				has_law = law_type:law_autocracy
			}
		}
		c:SPA = { set_variable = don_carlist_bonapartist_refuge }
		scope:legitimist_movement = {
			add_modifier = {
				name = cr_granted_carlos_asylum_france_bonapartist
				months = long_modifier_time
				is_decaying = yes
			}
		}
	}

	every_country = {
		limit = {
			has_diplomatic_relevance = c:SPA
			NOT = {
				this = ROOT
				this ?= c:SPA
			}
		}
		post_notification = cr_don_carlos_exile_provided
	}
}

don_carlos_support_claim_effect = {
	save_scope_as = don_carlos_exile_country
	if = {
		limit = {
			this ?= c:POR
		}
		set_variable = cr_carlos_supporting_absolutism_in_spain_var
		c:SPA = {
			trigger_event = { id =  cr_carlist_events.81 days = 5 }
		}
		custom_tooltip = cr_carlist_events.15.spain_likely_disapproves
		add_modifier = {
			name = cr_carlos_supporting_absolutism
			months = 121
		}
		change_infamy = 10
		show_as_tooltip = {
			c:SPA = {
				scope:carlist_movement = {
					add_modifier = {
						name = cr_don_carlos_absolutist_support	
					}
				}
			}
		}
		if = {
			limit = {
				c:GBR = {
					has_law = law_type:law_monarchy
					country_has_voting_franchise = yes
				}
			}
			change_relations = {
				country = c:GBR
				value = -30
			}
			every_country = {
				limit = {
					country_is_in_europe = yes
					has_diplomatic_relevance = c:SPA
					country_has_voting_franchise = yes
					country_rank >= rank_value:major_power
					NOT = { this ?= c:GBR }
				}
				change_relations = {
					country = ROOT
					value = -15
				}
			}
		}
		every_political_movement = {
			limit = {
				OR = {	#Should be replaced with appropriate movements when DLC releases
					is_political_movement_type = movement_royalist_constitutional
					is_political_movement_type = movement_liberal
					is_political_movement_type = movement_positivist
					is_political_movement_type = movement_modernizer
				}
			}
			add_modifier = {
				name = cr_don_carlos_absolutist_support_backlash
				months = 121
				is_decaying = yes
			}	
		}
		ig:ig_intelligentsia = {
			add_modifier = {
				name = cr_supporting_absolutism_abroad
				months = 121
				is_decaying = yes
			}			
		}
	}
	else_if = {
		c:SPA = {
			trigger_event = { id =  cr_carlist_events.20 days = 5 }
		}
		limit = {
			has_law = law_type:law_monarchy
			has_law = law_type:law_autocracy
		}
		show_as_tooltip = {
			c:SPA = {
				scope:carlist_movement = {
					add_modifier = {
						name = cr_don_carlos_absolutist_support	
					}
				}
			}
		}
		change_infamy = 7.5
		if = {
			limit = {
				NOT = {
					this ?= c:POR
				}
			}
			change_relations = {
				country = c:GBR
				value = -15
			}
			every_country = {
				limit = {
					country_is_in_europe = yes
					has_diplomatic_relevance = c:SPA
					country_has_voting_franchise = yes
					country_rank >= rank_value:major_power
					NOT = { this ?= c:GBR }
				}
				change_relations = {
					country = ROOT
					value = -10
				}
			}
		}
		else = {
			every_country = {
				limit = {
					country_is_in_europe = yes
					country_has_voting_franchise = yes
					country_rank >= rank_value:major_power
				}
				change_relations = {
					country = ROOT
					value = -10
				}
			}		
		}
		if = {
			limit = {
				c:POR = {
					has_law = law_type:law_monarchy
					NOT = { has_law = law_type:law_autocracy }
				}
			}
			change_relations = {
				country = c:POR
				value = -40
			}
		}
	}
	else = { 
		c:SPA = {
			trigger_event = { id =  cr_carlist_events.20 days = 5 }
		}
		show_as_tooltip = {
			c:SPA = {
				scope:carlist_movement = {
					add_modifier = {
						name = cr_don_carlos_exiled_but_supported	
					}
				}
			}
		}
		change_infamy = 5
		if = {
			limit = {
				c:GBR = {
					has_law = law_type:law_monarchy
					NOT = { has_law = law_type:law_autocracy }
				}
			}
			change_relations = {
				country = c:GBR
				value = -15
			}
		}
		if = {
			limit = {
				c:POR = {
					has_law = law_type:law_monarchy
					NOT = { has_law = law_type:law_autocracy }
				}
			}
			change_relations = {
				country = c:POR
				value = -20
			}
		}
	}
	if = {
		limit = {
			c:SIC = {
				has_law = law_type:law_monarchy
			}
		}
		change_relations = {
			country = c:SIC
			value = 10
		}
	}

	every_country = {
		limit = {
			has_diplomatic_relevance = c:SPA
			NOT = {
				this ?= ROOT
				this ?= c:SPA
			}
		}
		post_notification = cr_don_carlos_exile_supported
	}
}

don_carlos_reject_asylum_effect = {
	clear_saved_scope = don_carlos_exile_country
	save_scope_as = don_carlos_exile_rejected
	set_variable = don_carlos_exile_rejected_var
	custom_tooltip = {
		text = cr_carlist_events.15.c_tt
		random_list = {
			90 = {
				trigger = {
					NOT = {
						this ?= c:GBR
					}
					c:GBR = {
						NOT = { has_variable = don_carlos_exile_rejected_var }
					}
				}
				c:GBR = {
					trigger_event = { id = cr_carlist_events.16 days = 4 }
				}
			}
			40 = {
				trigger = {
					NOT = {
						this ?= c:POR
					}
					c:POR = {
						NOT = { has_variable = don_carlos_exile_rejected_var }
						has_law = law_type:law_monarchy
						has_law = law_type:law_autocracy
					}
				}
				c:POR = {
					trigger_event = { id = cr_carlist_events.80 days = 4 }
				}			
			}
			10 = {
				trigger = {
					NOT = {
						this ?= c:USA
					}
					c:USA = {
						NOT = { has_variable = don_carlos_exile_rejected_var }
					}
				}
				c:USA = {
					trigger_event = { id = cr_carlist_events.90 days = 14 }
				}
			}
		}
		c:SPA = {
			remove_variable = cr_don_carlos_exiled_bourges
		}
	}
	if = {
		limit = {
			has_law = law_type:law_monarchy
			ruler = {
				OR = { 
					has_ideology = ideology:ideology_orleanist
					has_ideology = ideology:ideology_legitimist
				}
			}
		}
		add_modifier = {
			name = cr_denied_dynasty_member_asylum
			months = normal_modifier_time 
			is_decaying = yes
		}
	}
	if = {
		limit = {
			has_law = law_type:law_monarchy
			ruler = {
				has_ideology = ideology:ideology_orleanist
			}
		}
	
		scope:legitimist_movement = {
			add_modifier = {
				name = cr_denied_carlos_france_legitimists	
				months = long_modifier_time
				is_decaying = yes
			}
		}
	}
	if = {
		limit = {
			NOT = {
				has_law = law_type:law_monarchy
			}
		}
		every_political_movement = {
			limit = {
				OR = {
					is_political_movement_type = movement_royalist_constitutional
					is_political_movement_type = movement_royalist_absolutist
					
				}
			}
			add_modifier = {
				name = cr_denied_carlos_british_royalist
				months = 61
				is_decaying = yes
			}	
		}
		every_interest_group = {
			limit = {
				leader = {
					OR ={
						has_ideology = ideology:ideology_royalist
						has_ideology = ideology:ideology_traditionalist
					}
				}
			}
			add_modifier = {
				name = cr_royal_denied_asylum_royalist_ig
				months = 61
				is_decaying = yes
			}	
		}
	}
	c:SPA = {
		change_relations = {
			country = ROOT
			value = 5
		}
	}
	if = {
		limit = {
			c:SIC = {
				has_law = law_type:law_monarchy
			}
		}
		change_relations = {
			country = c:SIC
			value = -5
		}
	}
}

don_carlos_undermine_legitimacy_effect = {
	clear_saved_scope = don_carlos_exile_country
	
	change_infamy = 3
	c:SPA = {
		trigger_event = { id =  cr_carlist_events.20 days = 5 }
	}
	show_as_tooltip = {
		c:SPA = {
			scope:carlist_movement = {
				add_modifier = {
					name = cr_don_carlos_legitimacy_undermined_movement	
				}
			}
			add_modifier = cr_don_carlos_legitimacy_undermined_country
		}
	}
	if = {
		limit = {
			c:SIC = {
				has_law = law_type:law_monarchy
			}
		}
		change_relations = {
			country = c:SIC
			value = -5
		}
	}
	if = {
		limit = {
			c:GBR = {
				has_law = law_type:law_monarchy
				NOT = { has_law = law_type:law_autocracy }
			}
		}
		change_relations = {
			country = c:GBR
			value = -5
		}
	}
	if = {
		limit = {
			c:POR = {
				has_law = law_type:law_monarchy
				NOT = { has_law = law_type:law_autocracy }
			}
		}
		change_relations = {
			country = c:POR
			value = -15
		}
	}
}